version: pipelines/v0.1
name: Load remote documents
timeout: 600
data_components:
  - gdrive
  - doc-converter
  - matatika
script: |-
  meltano install utility gdrive
  meltano install utility doc-converter
  meltano install utility matatika

  # system dependencies of doc-converter
  apt-get update -y && apt-get install -y \
    libgl1 \
    ghostscript \
    tesseract-ocr

  meltano run gdrive:run doc-converter

  set -e
  shopt -s nullglob
  shopt -s nocaseglob

  export MATATIKA_CONTEXT_HOME=.matatika

  for dataset in $DOC_CONVERTER_OUTPUT_DIR/*.{yaml,yml}
  do
    meltano invoke matatika publish "$dataset"
  done
